{% extends "base.html" %}

{% block title %}New Evaluation - {{ agent.name }} vs {{ reference_dataset.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/chatbots">ü§ñ Chatbots</a></li>
                <li class="breadcrumb-item"><a href="/chatbots/{{ agent.id }}">{{ agent.name }}</a></li>
                <li class="breadcrumb-item active">New Evaluation</li>
            </ol>
        </nav>
        
        <h1>üöÄ New Evaluation</h1>
        <p class="text-muted">Test <strong>{{ agent.name }}</strong> against <strong>{{ reference_dataset.name }}</strong> reference dataset</p>
    </div>
</div>

<!-- Selection Summary -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ü§ñ Selected Chatbot</h5>
            </div>
            <div class="card-body">
                <h6>{{ agent.name }}</h6>
                <p class="text-muted mb-2">{{ agent.description or "No description" }}</p>
                {% if agent.versions %}
                {% set latest_version = agent.versions[0] %}
                <div class="small">
                    <strong>Version:</strong> <span class="badge bg-info">{{ latest_version.display_name }}</span><br>
                    <strong>Model:</strong> {{ latest_version.model_config.provider }}/{{ latest_version.model_config.model }}<br>
                    <strong>Evaluation Mode:</strong> 
                    {% if latest_version.connector_enabled %}
                        <span class="badge bg-primary">üîå Live Evaluation</span>
                    {% else %}
                        <span class="badge bg-secondary">üìÅ Upload Answers</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Selected Reference Question Set</h5>
            </div>
            <div class="card-body">
                <h6>{{ reference_dataset.name }}</h6>
                <p class="text-muted mb-2">{{ reference_dataset.description or "No description" }}</p>
                <div class="small">
                    <strong>Rows:</strong> {{ reference_dataset.row_count }}<br>
                    <strong>Created:</strong> {{ reference_dataset.created_at.strftime('%Y-%m-%d') }}<br>
                    <strong>Chatbot Version:</strong> <span class="badge bg-info">{{ agent_version.display_name }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Run Configuration Form -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">‚öôÔ∏è Evaluation Configuration</h5>
            </div>
            <div class="card-body">
                {% if errors %}
                    <div class="alert alert-danger">
                        <h6>Please fix the following errors:</h6>
                        <ul class="mb-0">
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}

                <form method="post" action="/runs/new/upload" enctype="multipart/form-data">
                    <!-- Hidden fields for pre-selected agent version and reference dataset -->
                    <input type="hidden" name="agent_version_id" value="{{ agent_version.id }}">
                    <input type="hidden" name="reference_dataset_id" value="{{ reference_dataset.id }}">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Run Name *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ name or '' }}" 
                                       placeholder="{{ agent.name }} vs {{ reference_dataset.name }}"
                                       required>
                                <div class="form-text">Give this evaluation run a descriptive name</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="evaluation_source" class="form-label">Evaluation Mode *</label>
                                <select class="form-select" id="evaluation_source" name="evaluation_source" onchange="toggleFileUpload()" required>
                                    {% if agent.versions and agent.versions[0].connector_enabled %}
                                        <option value="connector">üîå Live Evaluation (Recommended)</option>
                                        <option value="upload">üìÅ Upload Pre-computed Answers</option>
                                    {% else %}
                                        <option value="upload">üìÅ Upload Pre-computed Answers</option>
                                        <option value="connector" disabled>üîå Live Evaluation (Not configured)</option>
                                    {% endif %}
                                </select>
                                <div class="form-text">
                                    Live evaluation will query your chatbot directly. Upload mode requires pre-computed answers.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Upload Section (conditionally shown) -->
                    <div id="file-upload-section" class="mb-3" {% if agent.versions and agent.versions[0].connector_enabled %}style="display: none;"{% endif %}>
                        <label for="file" class="form-label">Answers File *</label>
                        <input type="file" class="form-control" id="file" name="file" accept=".csv,.jsonl">
                        <div class="form-text">
                            Upload a CSV or JSONL file with columns: <code>question</code>, <code>answer</code>. 
                            Must cover all {{ reference_dataset.row_count }} test cases.
                        </div>
                    </div>

                    <!-- Preview Section -->
                    {% if agent.versions and reference_dataset %}
                    <div class="alert alert-info">
                        <h6 class="mb-2">üìã What will happen:</h6>
                        <ol class="mb-0">
                            {% if agent.versions[0].connector_enabled %}
                            <li><strong>Live Mode:</strong> We'll send each question to your chatbot and collect answers automatically</li>
                            {% else %}
                            <li><strong>Upload Mode:</strong> We'll use your pre-computed answers file</li>
                            {% endif %}
                            <li>Each answer will be evaluated using:
                                <ul>
                                    {% if agent.versions[0].llm_as_judge_enabled %}
                                    <li>ü§ñ <strong>LLM as Judge</strong> (threshold: {{ agent.versions[0].default_thresholds.llm_as_judge }})</li>
                                    {% endif %}
                                    {% if agent.versions[0].faithfulness_enabled %}
                                    <li>üéØ <strong>Faithfulness</strong> (threshold: {{ agent.versions[0].default_thresholds.faithfulness }})</li>
                                    {% endif %}
                                </ul>
                            </li>
                            <li>You'll get detailed results with scores, explanations, and pass/fail status</li>
                            <li>You can adjust thresholds after completion to re-score without re-evaluation</li>
                        </ol>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between">
                        <a href="/chatbots/{{ agent.id }}" class="btn btn-outline-secondary">‚Üê Back to Chatbot</a>
                        <button type="submit" class="btn btn-primary btn-lg">üöÄ Start Evaluation</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function toggleFileUpload() {
    const evaluationSource = document.getElementById('evaluation_source').value;
    const fileUploadSection = document.getElementById('file-upload-section');
    const fileInput = document.getElementById('file');
    
    if (evaluationSource === 'upload') {
        fileUploadSection.style.display = 'block';
        fileInput.required = true;
    } else {
        fileUploadSection.style.display = 'none';
        fileInput.required = false;
    }
}

// Auto-generate run name based on current selections
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('name');
    if (!nameInput.value || nameInput.value.includes('{{ agent.name }}')) {
        const today = new Date().toISOString().split('T')[0];
        nameInput.value = `{{ agent.name }} vs {{ reference_dataset.name }} - ${today}`;
    }
});
</script>
{% endblock %}