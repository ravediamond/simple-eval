{% extends "base.html" %}

{% block title %}{{ run.name }} - Run Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1>{{ run.name }}</h1>
                <div class="mt-2">
                    {% if run.status == 'completed' %}
                        <span class="badge bg-success fs-6">Completed</span>
                    {% elif run.status == 'running' %}
                        <span class="badge bg-primary fs-6">Running</span>
                    {% elif run.status == 'failed' %}
                        <span class="badge bg-danger fs-6">Failed</span>
                    {% else %}
                        <span class="badge bg-secondary fs-6">Pending</span>
                    {% endif %}
                </div>
            </div>
            <a href="/runs" class="btn btn-outline-secondary">Back to Runs</a>
        </div>
    </div>
</div>

<!-- Progress Bar (for running/pending runs) -->
{% if run.status in ['running', 'pending'] %}
<div class="row mt-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Progress</h6>
                    <span id="progress-text">{{ run.completed_test_cases }}/{{ run.total_test_cases }} cases</span>
                </div>
                <div class="progress" style="height: 25px;">
                    {% set progress = (run.completed_test_cases / run.total_test_cases * 100) if run.total_test_cases > 0 else 0 %}
                    <div id="progress-bar" class="progress-bar progress-bar-striped {% if run.status == 'running' %}progress-bar-animated{% endif %}" 
                         role="progressbar" style="width: {{ progress }}%" 
                         aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                        {{ "%.1f"|format(progress) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mt-4">
    <!-- Run Information -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Run Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <td><strong>Agent Version:</strong></td>
                        <td>
                            <a href="/agents/{{ run.agent_version.agent_id }}">{{ run.agent_version.agent.name }}</a>
                            <span class="badge bg-info ms-2">{{ run.agent_version.display_name }}</span>
                            {% if run.agent_version.notes %}
                                <br><small class="text-muted">{{ run.agent_version.notes }}</small>
                            {% endif %}
                            <br><small class="text-muted">
                                Created: {{ run.agent_version.created_at.strftime('%Y-%m-%d %H:%M') }}
                                | Model: {{ run.agent_version.model_config.provider }}/{{ run.agent_version.model_config.model }}
                            </small>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Evaluation Dataset:</strong></td>
                        <td>
                            {% if run.reference_dataset %}
                                {{ run.reference_dataset.name }}
                                <br><small class="text-muted">{{ run.reference_dataset.description }}</small>
                                <br><small class="text-muted">
                                    Created: {{ run.reference_dataset.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    • {{ run.reference_dataset.row_count }} rows
                                </small>
                            {% elif run.dataset_version %}
                                {{ run.dataset_version.dataset.name }}
                                <span class="badge bg-success ms-2">{{ run.dataset_version.display_name }}</span>
                                {% if run.dataset_version.notes %}
                                    <br><small class="text-muted">{{ run.dataset_version.notes }}</small>
                                {% endif %}
                                <br><small class="text-muted">
                                    Created: {{ run.dataset_version.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </small>
                            {% else %}
                                <span class="text-muted">No dataset</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Evaluation Source:</strong></td>
                        <td>
                            <span class="badge bg-{% if run.evaluation_source == 'connector' %}primary{% else %}secondary{% endif %}">
                                {% if run.evaluation_source == 'connector' %}
                                    🔌 Live Evaluation
                                {% else %}
                                    📁 Uploaded Answers
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Total Cases:</strong></td>
                        <td>{{ run.total_test_cases }}</td>
                    </tr>
                    <tr>
                        <td><strong>Created:</strong></td>
                        <td>{{ run.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% if run.started_at %}
                    <tr>
                        <td><strong>Started:</strong></td>
                        <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% endif %}
                    {% if run.completed_at %}
                    <tr>
                        <td><strong>Completed:</strong></td>
                        <td>{{ run.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="col-md-6">
        {% if run.status == 'completed' %}
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Results Summary</h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                            Export
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/runs/{{ run.id }}/export/csv">CSV</a></li>
                            <li><a class="dropdown-item" href="/runs/{{ run.id }}/export/json">JSON</a></li>
                            <li><a class="dropdown-item" href="/runs/{{ run.id }}/export/html">HTML Report</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row text-center mb-3">
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-1 text-{% if run.overall_score >= 0.8 %}success{% elif run.overall_score >= 0.6 %}warning{% else %}danger{% endif %}">
                                {{ "%.2f"|format(run.overall_score) }}
                            </h4>
                            <small class="text-muted">Overall Score</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-1 text-{% if run.pass_rate >= 0.8 %}success{% elif run.pass_rate >= 0.6 %}warning{% else %}danger{% endif %}">
                                {{ "%.1f"|format(run.pass_rate * 100) }}%
                            </h4>
                            <small class="text-muted">Pass Rate</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-1 text-success">{{ passed_cases }}</h4>
                            <small class="text-muted">Passed</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-1 text-danger">{{ failed_cases }}</h4>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                </div>
                
                {% if run.aggregate_results %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Metric Breakdown:</h6>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleThresholdOverrides()">
                        🎯 Adjust Thresholds
                    </button>
                </div>
                
                <!-- Threshold Override Panel -->
                <div id="threshold-override-panel" class="alert alert-light border" style="display: none;">
                    <form id="threshold-override-form">
                        <div class="row mb-2">
                            <div class="col-12">
                                <strong>Override Thresholds & Re-score:</strong>
                                <small class="text-muted d-block">Adjust pass/fail thresholds without re-running evaluation</small>
                            </div>
                        </div>
                        {% for metric_name, results in run.aggregate_results.items() %}
                        <div class="row mb-2">
                            <div class="col-6">
                                <label class="form-label">{{ metric_name|replace('_', ' ')|title }}:</label>
                            </div>
                            <div class="col-4">
                                <input type="number" class="form-control form-control-sm" 
                                       name="threshold_{{ metric_name }}" 
                                       step="0.01" min="0" max="1" 
                                       value="{{ run.threshold_overrides[metric_name] if run.threshold_overrides and metric_name in run.threshold_overrides else run.agent_version.default_thresholds[metric_name] }}"
                                       placeholder="{{ run.agent_version.default_thresholds[metric_name] }}">
                            </div>
                            <div class="col-2">
                                <small class="text-muted">Default: {{ run.agent_version.default_thresholds[metric_name] }}</small>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="row">
                            <div class="col-12">
                                <button type="button" class="btn btn-primary btn-sm" onclick="applyThresholdOverrides()">
                                    Re-score with New Thresholds
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="resetThresholds()">
                                    Reset to Defaults
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <table class="table table-sm">
                    {% for metric_name, results in run.aggregate_results.items() %}
                    <tr>
                        <td>{{ metric_name|replace('_', ' ')|title }}:</td>
                        <td>
                            <span class="badge bg-{% if results.score >= 0.8 %}success{% elif results.score >= 0.6 %}warning{% else %}danger{% endif %}">
                                {{ "%.2f"|format(results.score) }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">{{ "%.1f"|format(results.pass_rate * 100) }}% pass</small>
                        </td>
                        <td>
                            <small class="text-muted">
                                Threshold: 
                                <span class="threshold-display" data-metric="{{ metric_name }}">
                                    {{ run.threshold_overrides[metric_name] if run.threshold_overrides and metric_name in run.threshold_overrides else run.agent_version.default_thresholds[metric_name] }}
                                </span>
                                {% if run.threshold_overrides and metric_name in run.threshold_overrides %}
                                    <span class="badge bg-warning">Override</span>
                                {% endif %}
                            </small>
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filters and Search -->
{% if run.status == 'completed' %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Filters & Search</h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">All Cases</option>
                            <option value="failed" {% if current_filters.status == 'failed' %}selected{% endif %}>
                                Failed Only ({{ failed_cases }})
                            </option>
                            <option value="passed" {% if current_filters.status == 'passed' %}selected{% endif %}>
                                Passed Only ({{ passed_cases }})
                            </option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ current_filters.search or '' }}" 
                               placeholder="Search in questions, answers, or case IDs">
                    </div>
                    <div class="col-md-2">
                        <label for="min_score" class="form-label">Min Score</label>
                        <input type="number" class="form-control" id="min_score" name="min_score" 
                               step="0.01" min="0" max="1" value="{{ current_filters.min_score or '' }}" 
                               placeholder="0.0">
                    </div>
                    <div class="col-md-2">
                        <label for="sort_by" class="form-label">Sort By</label>
                        <select class="form-select" id="sort_by" name="sort_by">
                            <option value="case_id" {% if current_filters.sort_by == 'case_id' %}selected{% endif %}>Case ID</option>
                            <option value="score" {% if current_filters.sort_by == 'score' %}selected{% endif %}>Score</option>
                            <option value="status" {% if current_filters.sort_by == 'status' %}selected{% endif %}>Status</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="sort_desc" name="sort_desc" 
                                   {% if current_filters.sort_desc %}checked{% endif %}>
                            <label class="form-check-label" for="sort_desc">Desc</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="/runs/{{ run.id }}" class="btn btn-outline-secondary">Clear</a>
                        {% if current_filters.status == 'failed' %}
                            <span class="badge bg-info ms-2">Showing {{ test_cases|length }} failed cases</span>
                        {% elif current_filters.search %}
                            <span class="badge bg-info ms-2">Found {{ test_cases|length }} matching cases</span>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Test Cases Results -->
{% if run.status == 'completed' and test_cases %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Test Case Results ({{ test_cases|length }} of {{ total_cases }})</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-info" onclick="expandAllDetails()">Expand All</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllDetails()">Collapse All</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th style="width: 10%;">Case ID</th>
                                <th style="width: 25%;">Question</th>
                                <th style="width: 25%;">Answer</th>
                                <th style="width: 10%;">Score</th>
                                <th style="width: 10%;">Status</th>
                                <th style="width: 15%;">Metrics</th>
                                <th style="width: 5%;">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for test_case in test_cases %}
                            <tr class="{% if not test_case.passed %}table-danger{% endif %}">
                                <td><code>{{ test_case.case_id }}</code></td>
                                <td>
                                    <div class="truncate-text" style="max-width: 200px;" title="{{ test_case.question }}">
                                        {{ test_case.question }}
                                    </div>
                                </td>
                                <td>
                                    <div class="truncate-text" style="max-width: 250px;" title="{{ test_case.actual_answer }}">
                                        {{ test_case.actual_answer }}
                                    </div>
                                </td>
                                <td>
                                    {% if test_case.overall_score is not none %}
                                        <span class="badge bg-{% if test_case.overall_score >= 0.8 %}success{% elif test_case.overall_score >= 0.6 %}warning{% else %}danger{% endif %}">
                                            {{ "%.2f"|format(test_case.overall_score) }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if test_case.passed is not none %}
                                        {% if test_case.passed %}
                                            <span class="badge bg-success">✓ Pass</span>
                                        {% else %}
                                            <span class="badge bg-danger">✗ Fail</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% for metric in test_case.metric_results %}
                                        <span class="badge bg-{% if metric.passed %}success{% else %}danger{% endif %} me-1" 
                                              title="{{ metric.metric_name }}: {{ metric.score }} (threshold: {{ metric.threshold }})">
                                            {{ metric.metric_name.replace('_', ' ')|title }}: {{ "%.2f"|format(metric.score) }}
                                        </span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="toggleCaseDetails('{{ test_case.case_id }}')"
                                            id="btn-{{ test_case.case_id }}">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                </td>
                            </tr>
                            <!-- Expandable details row -->
                            <tr id="details-{{ test_case.case_id }}" style="display: none;" class="table-light">
                                <td colspan="7">
                                    <div class="p-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Full Question:</h6>
                                                <p class="border p-2 bg-white">{{ test_case.question }}</p>
                                                
                                                {% if test_case.context %}
                                                <h6>Context:</h6>
                                                <p class="border p-2 bg-white">{{ test_case.context }}</p>
                                                {% endif %}
                                                
                                                {% if test_case.expected_answer %}
                                                <h6>Expected Answer:</h6>
                                                <p class="border p-2 bg-white">{{ test_case.expected_answer }}</p>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Actual Answer:</h6>
                                                <p class="border p-2 bg-white">{{ test_case.actual_answer }}</p>
                                                
                                                <h6>Metric Details:</h6>
                                                {% for metric in test_case.metric_results %}
                                                <div class="card card-sm mb-2">
                                                    <div class="card-body p-2">
                                                        <div class="d-flex justify-content-between">
                                                            <strong>{{ metric.metric_name.replace('_', ' ')|title }}</strong>
                                                            <span class="badge bg-{% if metric.passed %}success{% else %}danger{% endif %}">
                                                                {{ "%.2f"|format(metric.score) }}
                                                            </span>
                                                        </div>
                                                        <small class="text-muted">
                                                            Threshold: {{ metric.threshold }} | 
                                                            {% if metric.execution_time_ms %}Time: {{ metric.execution_time_ms }}ms{% endif %}
                                                        </small>
                                                        {% if metric.reasoning %}
                                                        <div class="mt-1">
                                                            <small><strong>Reasoning:</strong> {{ metric.reasoning }}</small>
                                                        </div>
                                                        {% endif %}
                                                        
                                                        {% if metric.raw_judge_response %}
                                                        <div class="mt-2">
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleVerboseArtifacts('{{ test_case.case_id }}-{{ metric.metric_name }}')">
                                                                Show Judge Details
                                                            </button>
                                                            <div id="verbose-{{ test_case.case_id }}-{{ metric.metric_name }}" style="display: none;" class="mt-2">
                                                                <small><strong>Judge Prompt:</strong></small>
                                                                <pre class="bg-light p-2 small">{{ metric.judge_prompt_used or 'Not available' }}</pre>
                                                                <small><strong>Raw Judge Response:</strong></small>
                                                                <pre class="bg-light p-2 small">{{ metric.raw_judge_response }}</pre>
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<style>
.truncate-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,0,0,.075);
}

.card-sm .card-body {
    padding: 0.5rem;
}

.expandable-row {
    transition: all 0.3s ease;
}
</style>

<!-- Auto-refresh for running runs -->
{% if run.status in ['running', 'pending'] %}
<script>
function updateProgress() {
    fetch('/api/runs/{{ run.id }}/status')
        .then(response => response.json())
        .then(data => {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = data.progress + '%';
                progressBar.setAttribute('aria-valuenow', data.progress);
                progressBar.textContent = data.progress.toFixed(1) + '%';
                progressText.textContent = data.completed_test_cases + '/' + data.total_test_cases + ' cases';
            }
            
            if (data.status === 'completed' || data.status === 'failed') {
                location.reload();
            }
        })
        .catch(error => console.error('Error updating progress:', error));
}

// Update every 2 seconds
setInterval(updateProgress, 2000);
</script>
{% endif %}

<script>
function toggleCaseDetails(caseId) {
    const detailsRow = document.getElementById('details-' + caseId);
    const button = document.getElementById('btn-' + caseId);
    const icon = button.querySelector('i');
    
    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        icon.className = 'fas fa-chevron-up';
    } else {
        detailsRow.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
    }
}

function expandAllDetails() {
    const allDetailsRows = document.querySelectorAll('[id^="details-"]');
    const allButtons = document.querySelectorAll('[id^="btn-"]');
    
    allDetailsRows.forEach(row => {
        row.style.display = 'table-row';
    });
    
    allButtons.forEach(button => {
        const icon = button.querySelector('i');
        icon.className = 'fas fa-chevron-up';
    });
}

function collapseAllDetails() {
    const allDetailsRows = document.querySelectorAll('[id^="details-"]');
    const allButtons = document.querySelectorAll('[id^="btn-"]');
    
    allDetailsRows.forEach(row => {
        row.style.display = 'none';
    });
    
    allButtons.forEach(button => {
        const icon = button.querySelector('i');
        icon.className = 'fas fa-chevron-down';
    });
}

// Quick filter for failures
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus on failures if there are any
    const failedCount = {{ failed_cases }};
    if (failedCount > 0 && !window.location.search.includes('status=')) {
        const failuresButton = document.createElement('button');
        failuresButton.className = 'btn btn-sm btn-warning position-fixed';
        failuresButton.style.cssText = 'top: 20px; right: 20px; z-index: 1050;';
        failuresButton.innerHTML = 'Show ' + failedCount + ' Failures';
        failuresButton.onclick = function() {
            window.location.search = '?status=failed';
        };
        document.body.appendChild(failuresButton);
    }
});

function toggleVerboseArtifacts(artifactId) {
    const element = document.getElementById('verbose-' + artifactId);
    const button = event.target;
    
    if (element.style.display === 'none') {
        element.style.display = 'block';
        button.textContent = 'Hide Judge Details';
    } else {
        element.style.display = 'none';
        button.textContent = 'Show Judge Details';
    }
}

// Phase 8: Threshold Override Functions
function toggleThresholdOverrides() {
    const panel = document.getElementById('threshold-override-panel');
    const button = event.target;
    
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        button.textContent = '🎯 Hide Thresholds';
    } else {
        panel.style.display = 'none';
        button.textContent = '🎯 Adjust Thresholds';
    }
}

function applyThresholdOverrides() {
    const form = document.getElementById('threshold-override-form');
    const formData = new FormData(form);
    
    // Build threshold overrides object
    const thresholds = {};
    for (let [key, value] of formData.entries()) {
        if (key.startsWith('threshold_')) {
            const metricName = key.replace('threshold_', '');
            thresholds[metricName] = parseFloat(value);
        }
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Re-scoring...';
    button.disabled = true;
    
    // Send request to re-score endpoint
    fetch(`/api/runs/{{ run.id }}/rescore`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            threshold_overrides: thresholds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Reload the page to show updated results
            window.location.reload();
        } else {
            alert('Re-scoring failed: ' + data.message);
        }
    })
    .catch(error => {
        alert('Re-scoring failed: ' + error.message);
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

function resetThresholds() {
    // Reset all threshold inputs to their default values
    const form = document.getElementById('threshold-override-form');
    const inputs = form.querySelectorAll('input[name^="threshold_"]');
    
    inputs.forEach(input => {
        const placeholder = input.getAttribute('placeholder');
        input.value = placeholder;
    });
}
</script>
{% endblock %}