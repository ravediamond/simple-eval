{% extends "base.html" %}

{% block title %}Create Chatbot - Simple Eval{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Create Chatbot</h1>
            <a href="/chatbots" class="btn btn-outline-secondary">Back to Chatbots</a>
        </div>
        <p class="text-muted">Define a new chatbot with model configuration and evaluation settings</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                
                <form method="post" action="/chatbots">
                    <!-- Basic Information -->
                    <div class="mb-4">
                        <h5 class="mb-3">Basic Information</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="name" class="form-label">Name *</label>
                                <input type="text" class="form-control" id="name" name="name" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2" placeholder="Describe what this chatbot is designed to test"></textarea>
                        </div>
                    </div>

                    <!-- Model Configuration -->
                    <div class="mb-4">
                        <h5 class="mb-3">Model Configuration</h5>
                        <p class="text-muted small mb-3">This model will be used for both the chatbot responses and evaluation judging</p>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="model_provider" class="form-label">Provider *</label>
                                <select class="form-select" id="model_provider" name="model_provider" required onchange="updateProviderDefaults()">
                                    <option value="">Select provider</option>
                                    <option value="litellm_openai">OpenAI</option>
                                    <option value="litellm_anthropic">Anthropic</option>
                                    <option value="litellm_google">Google</option>
                                    <option value="litellm_aws">AWS Bedrock</option>
                                    <option value="litellm_azure">Azure OpenAI</option>
                                    <option value="litellm_ollama">Ollama (Local)</option>
                                    <option value="openai">OpenAI (Direct)</option>
                                    <option value="http">Custom HTTP</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="model_name" class="form-label">Model *</label>
                                <input type="text" class="form-control" id="model_name" name="model_name" placeholder="e.g., gpt-4, claude-3-opus" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="temperature" class="form-label">Temperature</label>
                                <input type="number" class="form-control" id="temperature" name="temperature" step="0.1" min="0" max="2" value="0.0">
                                <small class="form-text text-muted">0.0 for deterministic evaluation</small>
                            </div>
                            <div class="col-md-6">
                                <label for="max_tokens" class="form-label">Max Tokens</label>
                                <input type="number" class="form-control" id="max_tokens" name="max_tokens" min="1" value="1000">
                            </div>
                        </div>
                    </div>

                    <!-- Evaluation Settings (Collapsible) -->
                    <div class="accordion mb-4" id="evaluationAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#evaluationSettings">
                                    <strong>Evaluation Settings</strong>
                                </button>
                            </h2>
                            <div id="evaluationSettings" class="accordion-collapse collapse show" data-bs-parent="#evaluationAccordion">
                                <div class="accordion-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="llm_as_judge_enabled" name="llm_as_judge_enabled" checked>
                                                <label class="form-check-label" for="llm_as_judge_enabled">
                                                    Enable LLM-as-Judge
                                                </label>
                                            </div>
                                            <div class="form-text">Use the same model to evaluate response quality</div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="faithfulness_enabled" name="faithfulness_enabled" checked>
                                                <label class="form-check-label" for="faithfulness_enabled">
                                                    Enable Faithfulness
                                                </label>
                                            </div>
                                            <div class="form-text">Measure response adherence to source material</div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="judge_prompt" class="form-label">Custom Judge Prompt</label>
                                        <textarea class="form-control" id="judge_prompt" name="judge_prompt" rows="4" placeholder="Leave blank to use default judge prompt from LLM configurations">You are an expert evaluator assessing the quality and correctness of AI responses.

Please evaluate the given response to the question on the following criteria:
1. Accuracy: Is the response factually correct?
2. Completeness: Does it fully answer the question?
3. Clarity: Is it well-written and understandable?
4. Relevance: Does it directly address what was asked?

Provide a score from 0 to 1 (where 1 is excellent and 0 is poor) and explain your reasoning.</textarea>
                                        <div class="form-text">Custom prompt for evaluation. Leave blank to use system default.</div>
                                    </div>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="store_verbose_artifacts" name="store_verbose_artifacts">
                                        <label class="form-check-label" for="store_verbose_artifacts">
                                            Store Verbose Artifacts
                                        </label>
                                        <div class="form-text">Store judge prompts and raw responses for transparency and debugging</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Evaluation (Collapsible) -->
                    <div class="accordion mb-4" id="connectorAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#connectorSettings">
                                    <strong>Live Evaluation Connector</strong> <span class="text-muted ms-2">(Optional)</span>
                                </button>
                            </h2>
                            <div id="connectorSettings" class="accordion-collapse collapse" data-bs-parent="#connectorAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="connector_enabled" name="connector_enabled" onchange="toggleConnectorConfig()">
                                            <label class="form-check-label" for="connector_enabled">
                                                Enable Live Evaluation
                                            </label>
                                        </div>
                                        <div class="form-text">Allow this chatbot to evaluate questions directly via API instead of uploading pre-computed answers</div>
                                    </div>
                                    
                                    <div id="connector_config" style="display: none;">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="connector_type" class="form-label">Connector Type</label>
                                                <select class="form-select" id="connector_type" name="connector_type">
                                                    <option value="litellm_openai">LiteLLM OpenAI</option>
                                                    <option value="litellm_anthropic">LiteLLM Anthropic</option>
                                                    <option value="litellm_ollama">LiteLLM Ollama</option>
                                                    <option value="openai">OpenAI (Direct)</option>
                                                    <option value="http">Generic HTTP</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="connector_endpoint" class="form-label">API Endpoint *</label>
                                                <input type="url" class="form-control" id="connector_endpoint" name="connector_endpoint" 
                                                       placeholder="https://api.openai.com/v1/chat/completions">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="connector_api_key" class="form-label">API Key</label>
                                                <input type="password" class="form-control" id="connector_api_key" name="connector_api_key" 
                                                       placeholder="Optional API key">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="connector_model" class="form-label">Model Name</label>
                                                <input type="text" class="form-control" id="connector_model" name="connector_model" 
                                                       placeholder="e.g., gpt-3.5-turbo">
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="connector_timeout" class="form-label">Timeout (seconds)</label>
                                                <input type="number" class="form-control" id="connector_timeout" name="connector_timeout" 
                                                       value="30" min="5" max="300">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="connector_rate_limit" class="form-label">Rate Limit (per minute)</label>
                                                <input type="number" class="form-control" id="connector_rate_limit" name="connector_rate_limit" 
                                                       value="60" min="1" max="1000">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">&nbsp;</label>
                                                <button type="button" class="btn btn-outline-info d-block w-100" onclick="testConnection()">
                                                    Test Connection
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="connection_test_result" class="alert" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Create Chatbot</button>
                            <a href="/chatbots" class="btn btn-secondary ms-2">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Provider defaults
const providerDefaults = {
    'litellm_openai': {
        model_name: 'gpt-3.5-turbo'
    },
    'litellm_anthropic': {
        model_name: 'claude-3-haiku-20240307'
    },
    'litellm_google': {
        model_name: 'gemini-pro'
    },
    'litellm_aws': {
        model_name: 'anthropic.claude-3-haiku-20240307-v1:0'
    },
    'litellm_azure': {
        model_name: 'azure/gpt-35-turbo'
    },
    'litellm_ollama': {
        model_name: 'ollama/llama2'
    },
    'openai': {
        model_name: 'gpt-3.5-turbo'
    }
};

function updateProviderDefaults() {
    const provider = document.getElementById('model_provider').value;
    const defaults = providerDefaults[provider];
    
    if (defaults) {
        document.getElementById('model_name').value = defaults.model_name;
    }
}

// Connector configuration functions
function toggleConnectorConfig() {
    const enabled = document.getElementById('connector_enabled').checked;
    const config = document.getElementById('connector_config');
    config.style.display = enabled ? 'block' : 'none';
    
    // Reset test result when toggling
    const testResult = document.getElementById('connection_test_result');
    testResult.style.display = 'none';
}

function testConnection() {
    const connectorType = document.getElementById('connector_type').value;
    const endpoint = document.getElementById('connector_endpoint').value;
    const apiKey = document.getElementById('connector_api_key').value;
    const model = document.getElementById('connector_model').value;
    const timeout = document.getElementById('connector_timeout').value;
    
    if (!endpoint) {
        showTestResult('Please enter an API endpoint', 'danger');
        return;
    }
    
    // Show loading state
    const button = document.querySelector('button[onclick="testConnection()"]');
    const originalText = button.textContent;
    button.textContent = 'Testing...';
    button.disabled = true;
    
    // Prepare form data
    const formData = new FormData();
    formData.append('connector_type', connectorType);
    formData.append('endpoint_url', endpoint);
    formData.append('api_key', apiKey);
    formData.append('model_name', model);
    formData.append('timeout_seconds', timeout);
    
    fetch('/api/test-connector', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showTestResult(
                `✅ ${data.message}<br><small>Response: "${data.test_answer}" (${data.response_time_ms}ms)</small>`,
                'success'
            );
        } else {
            showTestResult(`❌ ${data.message}`, 'danger');
        }
    })
    .catch(error => {
        showTestResult(`❌ Test failed: ${error.message}`, 'danger');
    })
    .finally(() => {
        button.textContent = originalText;
        button.disabled = false;
    });
}

function showTestResult(message, type) {
    const testResult = document.getElementById('connection_test_result');
    testResult.className = `alert alert-${type}`;
    testResult.innerHTML = message;
    testResult.style.display = 'block';
}
</script>
{% endblock %}