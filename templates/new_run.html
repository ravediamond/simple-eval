{% extends "base.html" %}

{% block title %}New Run - Simple Eval{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1>Create New Run</h1>
            <a href="/runs" class="btn btn-outline-secondary">Back to Runs</a>
        </div>
        <p class="text-muted">Upload answers file to evaluate against a dataset using an agent</p>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                
                {% if errors %}
                    <div class="alert alert-danger">
                        <strong>Validation Errors:</strong>
                        <ul class="mb-0 mt-2">
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <form method="post" action="/runs/new/upload" enctype="multipart/form-data">
                    <!-- Run Configuration -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Run Configuration</h5>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="name" class="form-label">Run Name *</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ name or '' }}" required 
                                   placeholder="e.g., Customer Support Evaluation #1">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="agent_id" class="form-label">Agent *</label>
                            <select class="form-select" id="agent_id" name="agent_id" required onchange="updateAgentVersions()">
                                <option value="">Select an agent</option>
                                {% for agent in agents %}
                                    <option value="{{ agent.id }}">
                                        {{ agent.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="agent_version_id" class="form-label">Agent Version *</label>
                            <select class="form-select" id="agent_version_id" name="agent_version_id" required onchange="updateConnectorStatus()">
                                <option value="">Select agent first</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="dataset_id" class="form-label">Dataset *</label>
                            <select class="form-select" id="dataset_id" name="dataset_id" required onchange="updateDatasetVersions()">
                                <option value="">Select a dataset</option>
                                {% for dataset in datasets %}
                                    <option value="{{ dataset.id }}">
                                        {{ dataset.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="dataset_version_id" class="form-label">Dataset Version *</label>
                            <select class="form-select" id="dataset_version_id" name="dataset_version_id" required>
                                <option value="">Select dataset first</option>
                            </select>
                        </div>
                    </div>

                    <!-- Evaluation Source -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Evaluation Method</h5>
                            <hr>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="evaluation_source" id="upload_mode" value="upload" checked onchange="toggleEvaluationMode()">
                                <label class="form-check-label" for="upload_mode">
                                    Upload Answers File
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="evaluation_source" id="connector_mode" value="connector" onchange="toggleEvaluationMode()">
                                <label class="form-check-label" for="connector_mode">
                                    Live Evaluation (Connector)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Answers File Upload -->
                    <div id="upload_section">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>Answers File</h5>
                                <hr>
                            </div>
                        </div>
                    
                        <div class="row mb-3">
                            <div class="col-12">
                                <label for="file" class="form-label">Upload Answers File *</label>
                                <input type="file" class="form-control" id="file" name="file" 
                                       accept=".jsonl,.csv,.json">
                                <div class="form-text">
                                    Upload a file containing answers with format: <code>{"id": "case_id", "answer": "response text"}</code><br>
                                    Supported formats: .jsonl, .csv, .json<br>
                                    Must provide 100% coverage of dataset cases.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Live Evaluation Section -->
                    <div id="connector_section" style="display: none;">
                        <div class="row mb-4">
                            <div class="col-12">
                                <h5>Live Evaluation</h5>
                                <hr>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <strong>Live Evaluation Mode:</strong> The selected agent will evaluate each question in the dataset directly using its configured connector. 
                            Make sure the agent has a working connector configured.
                        </div>
                        
                        <div id="connector_info" class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Agent Connector Status</h6>
                            </div>
                            <div class="card-body">
                                <div id="connector_status">
                                    <span class="text-muted">Select an agent to see connector status</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Format Examples -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="accordion" id="formatExamples">
                                <div class="accordion-item">
                                    <h2 class="accordion-header">
                                        <button class="accordion-button collapsed" type="button" 
                                                data-bs-toggle="collapse" data-bs-target="#formatHelp">
                                            File Format Examples
                                        </button>
                                    </h2>
                                    <div id="formatHelp" class="accordion-collapse collapse" data-bs-parent="#formatExamples">
                                        <div class="accordion-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <strong>JSONL Format:</strong>
                                                    <pre class="bg-light p-2 mt-2"><code>{"id": "1", "answer": "Paris"}
{"id": "2", "answer": "42"}</code></pre>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>CSV Format:</strong>
                                                    <pre class="bg-light p-2 mt-2"><code>id,answer
1,Paris
2,42</code></pre>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>JSON Format:</strong>
                                                    <pre class="bg-light p-2 mt-2"><code>[
  {"id": "1", "answer": "Paris"},
  {"id": "2", "answer": "42"}
]</code></pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">Create Run</button>
                            <a href="/runs" class="btn btn-secondary ms-2">Cancel</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Evaluation mode switching
function toggleEvaluationMode() {
    const uploadMode = document.getElementById('upload_mode').checked;
    const uploadSection = document.getElementById('upload_section');
    const connectorSection = document.getElementById('connector_section');
    const fileInput = document.getElementById('file');
    
    if (uploadMode) {
        uploadSection.style.display = 'block';
        connectorSection.style.display = 'none';
        fileInput.required = true;
    } else {
        uploadSection.style.display = 'none';
        connectorSection.style.display = 'block';
        fileInput.required = false;
        updateConnectorStatus();
    }
}

function updateConnectorStatus() {
    const agentSelect = document.getElementById('agent_id');
    const versionSelect = document.getElementById('agent_version_id');
    const statusDiv = document.getElementById('connector_status');
    
    if (!agentSelect.value || !versionSelect.value) {
        statusDiv.innerHTML = '<span class="text-muted">Select an agent and version to see connector status</span>';
        return;
    }
    
    const agentId = agentSelect.value;
    const versionId = versionSelect.value;
    
    // Find agent version in data
    let connectorEnabled = false;
    let connectorConfig = null;
    
    if (agentData[agentId]) {
        const version = agentData[agentId].find(v => v.id == versionId);
        if (version && version.connector_enabled) {
            connectorEnabled = true;
            connectorConfig = version.connector_config;
        }
    }
    
    if (connectorEnabled && connectorConfig) {
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="badge bg-success me-2">✓ Enabled</span>
                <span>${connectorConfig.connector_type} - ${connectorConfig.endpoint_url}</span>
            </div>
            <small class="text-muted">Model: ${connectorConfig.model_name || 'Default'} | Rate limit: ${connectorConfig.rate_limit_per_minute || 60}/min</small>
        `;
    } else {
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <span class="badge bg-danger me-2">✗ Not Configured</span>
                <span>This agent version does not have a connector configured</span>
            </div>
            <small class="text-muted">You need to configure a connector for live evaluation</small>
        `;
    }
}

// Agent and version selection data
const agentData = {
    {% for agent in agents %}
    "{{ agent.id }}": [
        {% for version in agent.versions %}
        {
            "id": {{ version.id }},
            "name": "{{ version.display_name }}",
            "model": "{{ version.model_config.provider }}/{{ version.model_config.model }}",
            "connector_enabled": {{ version.connector_enabled|lower }},
            "connector_config": {{ version.connector_config|tojson if version.connector_config else 'null' }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

const datasetData = {
    {% for dataset in datasets %}
    "{{ dataset.id }}": [
        {% for version in dataset.versions %}
        {
            "id": {{ version.id }},
            "name": "{{ version.display_name }}",
            "rows": {{ version.row_count }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]{% if not loop.last %},{% endif %}
    {% endfor %}
};

function updateAgentVersions() {
    const agentSelect = document.getElementById('agent_id');
    const versionSelect = document.getElementById('agent_version_id');
    
    versionSelect.innerHTML = '<option value="">Select agent version</option>';
    
    if (agentSelect.value && agentData[agentSelect.value]) {
        agentData[agentSelect.value].forEach(version => {
            const option = document.createElement('option');
            option.value = version.id;
            option.textContent = `${version.name} (${version.model})`;
            versionSelect.appendChild(option);
        });
        
        // Auto-select latest version
        if (agentData[agentSelect.value].length > 0) {
            versionSelect.value = agentData[agentSelect.value][0].id;
        }
    }
    
    // Update connector status if in connector mode
    if (!document.getElementById('upload_mode').checked) {
        updateConnectorStatus();
    }
}

function updateDatasetVersions() {
    const datasetSelect = document.getElementById('dataset_id');
    const versionSelect = document.getElementById('dataset_version_id');
    
    versionSelect.innerHTML = '<option value="">Select dataset version</option>';
    
    if (datasetSelect.value && datasetData[datasetSelect.value]) {
        datasetData[datasetSelect.value].forEach(version => {
            const option = document.createElement('option');
            option.value = version.id;
            option.textContent = `${version.name} (${version.rows} cases)`;
            versionSelect.appendChild(option);
        });
        
        // Auto-select latest version
        if (datasetData[datasetSelect.value].length > 0) {
            versionSelect.value = datasetData[datasetSelect.value][0].id;
        }
    }
}

// Initialize on page load if selections exist
document.addEventListener('DOMContentLoaded', function() {
    {% if selected_agent_version %}
    updateAgentVersions();
    document.getElementById('agent_version_id').value = {{ selected_agent_version }};
    {% endif %}
    
    {% if selected_dataset_version %}
    updateDatasetVersions();
    document.getElementById('dataset_version_id').value = {{ selected_dataset_version }};
    {% endif %}
});
</script>
{% endblock %}